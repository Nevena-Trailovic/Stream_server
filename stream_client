#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include<WinSock2.h>
#include<WS2tcpip.h>
#pragma comment(lib, "ws2_32.lib")
#include <iostream>
#include<string>
using namespace std;

#define BUF_SIZE 1024
//#define SERVER_PORT 8888

void ExitWithError(const string& message)
{
    cout << message << WSAGetLastError() << endl;
    WSACleanup();
    exit(1);
}
void printMessage(char* message, int len)
{
    cout << "Poslata poruka: ";
    for (int i = 0; i < len; i++)
        cout << message[i];
    cout << endl;
}

int main()
{
    string ip;
    int serverPort;
    cin >> ip >> serverPort;
    cin.ignore();
    WSAData wsa;
    SOCKET clientSocket;
    if (WSAStartup(0x0202, &wsa) != 0)
        ExitWithError("Startup failed");
    if ((clientSocket = socket(AF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET)
        ExitWithError("Listening socket not created");
    sockaddr_in server;
    server.sin_family = AF_INET;
    //server.sin_addr.s_addr = inet_addr("127.0.0.1");
    server.sin_addr.s_addr = inet_addr(ip.c_str());

   /* if (inet_pton(AF_INET, ip.c_str(), &serverAddr.sin_addr) <= 0)
    {
        cout << "Neispravna IP adresa!" << endl;
        return 1;
    }*/

    server.sin_port = htons(serverPort);  // host (little endian) to network (big endian) short

    if (connect(clientSocket, (struct sockaddr*)&server, sizeof(server)) == SOCKET_ERROR)
        ExitWithError("connect() failed");
    while (true)
    {
        string echoBuf;
        getline(cin, echoBuf);

        if (send(clientSocket, echoBuf.c_str(), echoBuf.length(), 0) != echoBuf.length())
            ExitWithError("send() failed");
        int recvMsgSize = 0;
        char* buff = (char*)malloc(BUF_SIZE);
        do
        {
            if ((recvMsgSize = recv(clientSocket, buff, BUF_SIZE, 0)) < 0)
                ExitWithError("recv() failed");
            printMessage(buff, recvMsgSize);
        } while (recvMsgSize == BUF_SIZE);
        free(buff);
    }
    closesocket(clientSocket);
    WSACleanup();
    return 0;
}
